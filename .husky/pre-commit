#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "Running security checks before commit..."

# Get list of staged PHP files
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(php)$')

if [ -n "$STAGED_PHP_FILES" ]; then
    echo "Running PHPStan on staged files..."
    # Run PHPStan on staged files only
    echo "$STAGED_PHP_FILES" | xargs vendor/bin/phpstan analyse --no-progress || {
        echo "PHPStan found issues. Please fix them before committing."
        exit 1
    }
    
    echo "Running PHP_CodeSniffer on staged files..."
    # Run PHP_CodeSniffer on staged files only
    echo "$STAGED_PHP_FILES" | xargs vendor/bin/phpcs --standard=PSR12,Security || {
        echo "PHP_CodeSniffer found issues. Please fix them before committing."
        exit 1
    }
fi

# Always check dependencies for vulnerabilities
echo "Checking dependencies for vulnerabilities..."
composer security:deps || {
    echo "Security vulnerabilities found in dependencies. Review them before committing."
    # We don't exit with error here to allow commits even with vulnerable dependencies
    # This is just a warning, but you can change to exit 1 if you want to block commits
}

echo "All security checks passed!"
exit 0 